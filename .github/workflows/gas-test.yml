name: Gas Test

on:
  workflow_call:

jobs:
  Test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Checkout solidity workflows repository
        uses: actions/checkout@v4
        with:
          repository: The-Poolz/solidity-workflows
          ref: master
          path: solidity-workflows

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.9.0

      - name: Restore node modules cache
        uses: actions/cache/restore@v4
        with:
          path: |
            node_modules
            ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}

      - name: Run tests
        run: npx hardhat test

      - name: Read gasReport.md file
        id: read_md
        run: |
          echo "::set-output name=content::$(cat gasReport.md)"

      - name: Post comment
        uses: actions/github-script@v4
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const content = `${process.env.read_md}`;
            const { context, github } = require('@actions/github');
            const comment = `@${context.payload.pull_request.user.login} Here's the content of the gasReport.md file:\n\n${content}`;
            await github.issues.createComment({
              issue_number: context.payload.pull_request.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
